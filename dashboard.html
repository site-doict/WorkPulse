<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WorkPulse ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0f1e;
    --surface: #0f1629;
    --surface2: #151d35;
    --border: rgba(99,179,237,0.12);
    --accent: #63b3ed;
    --accent2: #4fd1c5;
    --green: #48bb78;
    --red: #fc8181;
    --yellow: #f6e05e;
    --text: #e2e8f0;
    --muted: #718096;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  body {
    font-family: var(--font-display);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(99,179,237,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(99,179,237,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Ambient glows */
  body::after {
    content: '';
    position: fixed;
    top: -200px;
    left: -200px;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(99,179,237,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .glow-right {
    position: fixed;
    bottom: -200px;
    right: -200px;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(79,209,197,0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ */
  #notif-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
  }

  .notif {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    border-radius: 10px;
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 600;
    min-width: 280px;
    backdrop-filter: blur(12px);
    border: 1px solid transparent;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    transform: translateX(120%);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s ease;
    pointer-events: all;
  }
  .notif.show { transform: translateX(0); opacity: 1; }
  .notif.hide { transform: translateX(120%); opacity: 0; }

  .notif.success { background: rgba(72,187,120,0.15); border-color: rgba(72,187,120,0.4); color: #9ae6b4; }
  .notif.error   { background: rgba(252,129,129,0.15); border-color: rgba(252,129,129,0.4); color: #fed7d7; }
  .notif.info    { background: rgba(99,179,237,0.15); border-color: rgba(99,179,237,0.4); color: #bee3f8; }

  .notif-icon { font-size: 18px; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 24px 20px 60px;
  }

  /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 28px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 28px;
    gap: 16px;
    flex-wrap: wrap;
    animation: fadeDown 0.5s ease both;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }

  .brand-name {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .brand-sub { font-size: 11px; color: var(--muted); font-family: var(--font-mono); margin-top: 1px; }

  .topbar-right { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }

  #user-email {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--muted);
    background: var(--surface2);
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  .btn-logout {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 13px;
    padding: 9px 20px;
    border-radius: 8px;
    border: 1px solid rgba(252,129,129,0.3);
    background: rgba(252,129,129,0.08);
    color: var(--red);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }
  .btn-logout:hover { background: rgba(252,129,129,0.18); border-color: rgba(252,129,129,0.6); }

  /* ‚îÄ‚îÄ CLOCK CARD ‚îÄ‚îÄ */
  .clock-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 36px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
    animation: fadeDown 0.5s 0.1s ease both;
    position: relative;
    overflow: hidden;
  }

  .clock-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2), transparent);
  }

  .clock-group { display: flex; flex-direction: column; gap: 4px; }
  .clock-label { font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; font-family: var(--font-mono); }

  #live-clock {
    font-family: var(--font-mono);
    font-size: clamp(28px, 5vw, 46px);
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 2px;
    line-height: 1;
  }

  #live-date {
    font-family: var(--font-mono);
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
  }

  .clock-tz {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--accent2);
  }

  .tz-dot {
    width: 8px; height: 8px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ‚îÄ‚îÄ ACTION CARDS ‚îÄ‚îÄ */
  .actions-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
    animation: fadeDown 0.5s 0.2s ease both;
  }

  .action-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    transition: border-color 0.2s, background 0.2s;
  }

  .action-card:hover { border-color: rgba(99,179,237,0.25); }

  .action-info { display: flex; flex-direction: column; gap: 4px; }
  .action-title { font-size: 15px; font-weight: 700; }
  .action-sub { font-size: 12px; color: var(--muted); font-family: var(--font-mono); }

  .btn-action {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 14px;
    padding: 12px 24px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    letter-spacing: 0.3px;
    position: relative;
    overflow: hidden;
  }

  .btn-action::after {
    content: '';
    position: absolute;
    inset: 0;
    background: white;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .btn-action:active::after { opacity: 0.1; }

  .btn-in {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
    box-shadow: 0 4px 20px rgba(72,187,120,0.25);
  }
  .btn-in:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(72,187,120,0.35); }

  .btn-out {
    background: linear-gradient(135deg, #fc8181, #e53e3e);
    color: white;
    box-shadow: 0 4px 20px rgba(252,129,129,0.25);
  }
  .btn-out:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(252,129,129,0.35); }

  .btn-action:disabled {
    opacity: 0.45;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    animation: fadeDown 0.5s 0.3s ease both;
  }

  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 28px 16px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
  }

  .table-title {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .table-title-icon {
    width: 32px; height: 32px;
    background: rgba(99,179,237,0.12);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
  }

  .badge {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    background: rgba(99,179,237,0.12);
    color: var(--accent);
    border: 1px solid rgba(99,179,237,0.2);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    padding: 12px 20px;
    text-align: left;
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
  }

  tbody tr {
    border-bottom: 1px solid rgba(99,179,237,0.06);
    transition: background 0.15s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(99,179,237,0.04); }

  tbody td {
    padding: 14px 20px;
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--text);
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .status-present {
    background: rgba(72,187,120,0.12);
    color: #9ae6b4;
    border: 1px solid rgba(72,187,120,0.25);
  }

  .status-absent {
    background: rgba(252,129,129,0.12);
    color: #fed7d7;
    border: 1px solid rgba(252,129,129,0.25);
  }

  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

  .empty-row td {
    text-align: center;
    padding: 48px;
    color: var(--muted);
    font-size: 14px;
  }

  /* ‚îÄ‚îÄ LOADING SPINNER ‚îÄ‚îÄ */
  .spinner {
    display: inline-block;
    width: 20px; height: 20px;
    border: 2px solid rgba(99,179,237,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    .actions-row { grid-template-columns: 1fr; }
    .action-card { flex-direction: column; align-items: flex-start; }
    .btn-action { width: 100%; }
    .clock-card { flex-direction: column; }
    #live-clock { font-size: 32px; }
  }
</style>
</head>
<body>
<div class="glow-right"></div>

<div id="notif-container"></div>

<div class="wrapper">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-icon">‚ö°</div>
      <div>
        <div class="brand-name">WorkPulse</div>
        <div class="brand-sub">ATTENDANCE SYSTEM</div>
      </div>
    </div>
    <div class="topbar-right">
      <div id="user-email">loading...</div>
      <button class="btn-logout" id="logoutBtn">Sign Out</button>
    </div>
  </header>

  <!-- CLOCK -->
  <div class="clock-card">
    <div class="clock-group">
      <div class="clock-label">üïê Live Time ‚Äî Bangladesh</div>
      <div id="live-clock">00:00:00</div>
      <div id="live-date">‚Äî</div>
    </div>
    <div class="clock-tz">
      <div class="tz-dot"></div>
      Asia / Dhaka (GMT+6)
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions-row">
    <div class="action-card">
      <div class="action-info">
        <div class="action-title">üü¢ Mark In</div>
        <div class="action-sub">Record your arrival time</div>
      </div>
      <button class="btn-action btn-in" id="inBtn">Mark In</button>
    </div>
    <div class="action-card">
      <div class="action-info">
        <div class="action-title">üî¥ Mark Out</div>
        <div class="action-sub">Record your departure time</div>
      </div>
      <button class="btn-action btn-out" id="outBtn">Mark Out</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <div class="table-header">
      <div class="table-title">
        <div class="table-title-icon">üìã</div>
        Attendance History
      </div>
      <div class="badge">Last 7 Days</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>In Time</th>
          <th>Out Time</th>
          <th>Duration</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="attendanceList">
        <tr class="empty-row"><td colspan="5"><div class="spinner"></div></td></tr>
      </tbody>
    </table>
  </div>

</div>

<script type="module">
import { checkSession, logoutUser } from "./js/auth.js";
import { supabase } from "./js/auth.js";

/* ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ */
function notify(msg, type = "info") {
  const icons = { success: "‚úì", error: "‚úï", info: "‚Ñπ" };
  const c = document.getElementById("notif-container");
  const el = document.createElement("div");
  el.className = `notif ${type}`;
  el.innerHTML = `<span class="notif-icon">${icons[type]}</span><span>${msg}</span>`;
  c.appendChild(el);

  requestAnimationFrame(() => {
    requestAnimationFrame(() => el.classList.add("show"));
  });

  setTimeout(() => {
    el.classList.add("hide");
    el.addEventListener("transitionend", () => el.remove(), { once: true });
  }, 3500);
}

/* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
function updateClock() {
  const now = new Date();
  const timeOpts = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false, timeZone: "Asia/Dhaka" };
  const dateOpts = { weekday: "long", year: "numeric", month: "long", day: "numeric", timeZone: "Asia/Dhaka" };
  document.getElementById("live-clock").textContent = now.toLocaleTimeString("en-US", timeOpts);
  document.getElementById("live-date").textContent = now.toLocaleDateString("en-US", dateOpts);
}
updateClock();
setInterval(updateClock, 1000);

/* ‚îÄ‚îÄ ATTENDANCE ‚îÄ‚îÄ */
function calcDuration(inT, outT) {
  if (!inT || !outT) return "‚Äî";
  const diff = Math.floor((new Date(outT) - new Date(inT)) / 60000);
  const h = Math.floor(diff / 60);
  const m = diff % 60;
  return `${h}h ${m}m`;
}

async function loadAttendance(userId) {
  const { data, error } = await supabase
    .from("attendance")
    .select("*")
    .eq("user_id", userId)
    .order("date", { ascending: false })
    .limit(7);
  if (error) { notify(error.message, "error"); return []; }
  return data;
}

function renderTable(data) {
  const tbody = document.getElementById("attendanceList");
  if (!data || data.length === 0) {
    tbody.innerHTML = `<tr class="empty-row"><td colspan="5">No attendance records found.</td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(a => {
    const tOpts = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true, timeZone: "Asia/Dhaka" };
    const inT  = a.in_time  ? new Date(a.in_time).toLocaleTimeString("en-US", tOpts)  : "‚Äî";
    const outT = a.out_time ? new Date(a.out_time).toLocaleTimeString("en-US", tOpts) : "‚Äî";
    const dur  = calcDuration(a.in_time, a.out_time);
    const dateStr = new Date(a.date + "T00:00:00Z").toLocaleDateString("en-US", {
      weekday: "short", day: "2-digit", month: "short", year: "numeric", timeZone: "Asia/Dhaka"
    });
    const statusClass = (a.status || "").toLowerCase() === "present" ? "status-present" : "status-absent";
    return `
      <tr>
        <td>${dateStr}</td>
        <td>${inT}</td>
        <td>${outT}</td>
        <td>${dur}</td>
        <td><span class="status-badge ${statusClass}"><span class="status-dot"></span>${a.status || "‚Äî"}</span></td>
      </tr>`;
  }).join("");
}

async function markIn(userId) {
  const now = new Date();
  const date = now.toLocaleDateString("en-CA", { timeZone: "Asia/Dhaka" }); // YYYY-MM-DD

  const { data: existing } = await supabase.from("attendance").select("*")
    .eq("user_id", userId).eq("date", date).maybeSingle();

  if (existing) {
    const t = new Date(existing.in_time).toLocaleTimeString("en-US", { hour12: true, timeZone: "Asia/Dhaka" });
    notify(`Already marked In today at ${t}`, "info");
    return false;
  }

  const { error } = await supabase.from("attendance").insert([{
    user_id: userId, date, in_time: now.toISOString(), status: "Present"
  }]);

  if (error) { notify(error.message, "error"); return false; }
  const t = now.toLocaleTimeString("en-US", { hour12: true, timeZone: "Asia/Dhaka" });
  notify(`‚úÖ Marked In at ${t}`, "success");
  return true;
}

async function markOut(userId) {
  const now = new Date();
  const date = now.toLocaleDateString("en-CA", { timeZone: "Asia/Dhaka" });

  const { data: existing } = await supabase.from("attendance").select("*")
    .eq("user_id", userId).eq("date", date).maybeSingle();

  if (!existing) { notify("Mark In first!", "error"); return false; }
  if (existing.out_time) {
    const t = new Date(existing.out_time).toLocaleTimeString("en-US", { hour12: true, timeZone: "Asia/Dhaka" });
    notify(`Already marked Out today at ${t}`, "info");
    return false;
  }

  const { error } = await supabase.from("attendance").update({ out_time: now.toISOString() })
    .eq("user_id", userId).eq("date", date);

  if (error) { notify(error.message, "error"); return false; }
  const t = now.toLocaleTimeString("en-US", { hour12: true, timeZone: "Asia/Dhaka" });
  notify(`üî¥ Marked Out at ${t}`, "success");
  return true;
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
const user = await checkSession();
document.getElementById("user-email").textContent = user.email;

async function refresh() {
  const data = await loadAttendance(user.id);
  renderTable(data);
}
refresh();

document.getElementById("inBtn").addEventListener("click", async () => {
  document.getElementById("inBtn").disabled = true;
  const ok = await markIn(user.id);
  if (ok) await refresh();
  document.getElementById("inBtn").disabled = false;
});

document.getElementById("outBtn").addEventListener("click", async () => {
  document.getElementById("outBtn").disabled = true;
  const ok = await markOut(user.id);
  if (ok) await refresh();
  document.getElementById("outBtn").disabled = false;
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  notify("Signing out‚Ä¶", "info");
  setTimeout(logoutUser, 800);
});
</script>
</body>
</html>
