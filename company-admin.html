<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#f97316">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WorkPulse Admin">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>WorkPulse ‚Äî Company Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #080c14; --surface: #0d1320; --surface2: #121928;
    --border: rgba(148,163,184,0.08); --border2: rgba(148,163,184,0.14);
    --accent: #f97316; --accent2: #fb923c;
    --green: #34d399; --red: #f87171; --yellow: #fbbf24;
    --text: #e2e8f0; --text2: #94a3b8; --muted: #475569;
    --font: 'Outfit', sans-serif; --mono: 'DM Mono', monospace;
  }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  body::before { content:''; position:fixed; inset:0; background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(249,115,22,0.07) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 100%, rgba(96,165,250,0.05) 0%, transparent 60%); pointer-events:none; z-index:0; }
  #notif { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
  .notif { display:flex; align-items:center; gap:10px; padding:12px 18px; border-radius:10px; font-family:var(--mono); font-size:12px; font-weight:500; min-width:260px; border:1px solid transparent; box-shadow:0 8px 32px rgba(0,0,0,0.5); transform:translateX(110%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); pointer-events:all; }
  .notif.show { transform:translateX(0); }
  .notif.hide { transform:translateX(110%); transition:transform 0.3s ease; }
  .notif.success { background:rgba(52,211,153,0.12); border-color:rgba(52,211,153,0.3); color:#6ee7b7; }
  .notif.error   { background:rgba(248,113,113,0.12); border-color:rgba(248,113,113,0.3); color:#fca5a5; }
  .notif.info    { background:rgba(96,165,250,0.12); border-color:rgba(96,165,250,0.3); color:#93c5fd; }
  .app { display:flex; min-height:100vh; position:relative; z-index:1; }
  .sidebar { width:240px; flex-shrink:0; background:var(--surface); border-right:1px solid var(--border); display:flex; flex-direction:column; padding:24px 0; position:fixed; top:0; left:0; bottom:0; z-index:500; }
  .sidebar-brand { display:flex; align-items:center; gap:10px; padding:0 20px 24px; border-bottom:1px solid var(--border); margin-bottom:20px; }
  .sidebar-brand-icon { width:36px; height:36px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:16px; }
  .sidebar-brand-name { font-size:16px; font-weight:800; color:var(--text); }
  .sidebar-brand-role { font-size:10px; color:var(--accent); font-family:var(--mono); letter-spacing:1px; }
  .nav-section { padding:0 12px; margin-bottom:4px; }
  .nav-label { font-size:10px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; font-family:var(--mono); padding:0 8px; margin-bottom:6px; }
  .nav-item { display:flex; align-items:center; gap:10px; padding:9px 12px; border-radius:8px; font-size:13px; font-weight:500; color:var(--text2); cursor:pointer; transition:all 0.15s; border:1px solid transparent; margin-bottom:2px; }
  .nav-item:hover { background:rgba(148,163,184,0.06); color:var(--text); }
  .nav-item.active { background:rgba(249,115,22,0.12); color:var(--accent); border-color:rgba(249,115,22,0.2); }
  .nav-icon { font-size:15px; width:20px; text-align:center; }
  .sidebar-bottom { margin-top:auto; padding:16px 12px 0; border-top:1px solid var(--border); }
  .sidebar-user { padding:10px 12px; }
  .sidebar-email { font-family:var(--mono); font-size:11px; color:var(--text2); margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .btn-logout { width:100%; padding:9px; border-radius:8px; cursor:pointer; border:1px solid rgba(248,113,113,0.25); background:rgba(248,113,113,0.07); color:var(--red); font-family:var(--font); font-size:13px; font-weight:600; transition:all 0.2s; }
  .btn-logout:hover { background:rgba(248,113,113,0.15); }
  .main { margin-left:240px; flex:1; padding:28px; min-height:100vh; }
  .page { display:none; }
  .page.active { display:block; animation:fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .page-header { margin-bottom:24px; }
  .page-title { font-size:24px; font-weight:800; margin-bottom:4px; }
  .page-sub { font-size:13px; color:var(--text2); font-family:var(--mono); }
  .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:20px; position:relative; overflow:hidden; }
  .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
  .stat-card.orange::before { background:linear-gradient(90deg,var(--accent),transparent); }
  .stat-card.green::before  { background:linear-gradient(90deg,var(--green),transparent); }
  .stat-card.red::before    { background:linear-gradient(90deg,var(--red),transparent); }
  .stat-card.yellow::before { background:linear-gradient(90deg,var(--yellow),transparent); }
  .stat-icon { font-size:22px; margin-bottom:12px; }
  .stat-value { font-size:32px; font-weight:800; line-height:1; margin-bottom:4px; }
  .stat-card.orange .stat-value { color:var(--accent); }
  .stat-card.green  .stat-value { color:var(--green); }
  .stat-card.red    .stat-value { color:var(--red); }
  .stat-card.yellow .stat-value { color:var(--yellow); }
  .stat-label { font-size:12px; color:var(--text2); font-family:var(--mono); }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-bottom:20px; }
  .card-header { display:flex; align-items:center; justify-content:space-between; padding:16px 22px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:10px; }
  .card-title { font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  thead th { padding:10px 16px; text-align:left; font-family:var(--mono); font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); background:var(--surface2); border-bottom:1px solid var(--border); }
  tbody tr { border-bottom:1px solid rgba(148,163,184,0.05); transition:background 0.1s; }
  tbody tr:last-child { border-bottom:none; }
  tbody tr:hover { background:rgba(148,163,184,0.03); }
  tbody td { padding:12px 16px; font-family:var(--mono); font-size:12px; color:var(--text); vertical-align:middle; }
  .badge { display:inline-flex; align-items:center; gap:5px; font-size:10px; padding:3px 10px; border-radius:20px; font-weight:600; letter-spacing:0.5px; font-family:var(--mono); }
  .badge-green  { background:rgba(52,211,153,0.1);  color:#6ee7b7; border:1px solid rgba(52,211,153,0.2); }
  .badge-red    { background:rgba(248,113,113,0.1); color:#fca5a5; border:1px solid rgba(248,113,113,0.2); }
  .badge-yellow { background:rgba(251,191,36,0.1);  color:#fde68a; border:1px solid rgba(251,191,36,0.2); }
  .badge-orange { background:rgba(249,115,22,0.1);  color:#fdba74; border:1px solid rgba(249,115,22,0.2); }
  .badge-muted  { background:rgba(148,163,184,0.08); color:var(--text2); border:1px solid var(--border); }
  .badge-dot { width:5px; height:5px; border-radius:50%; background:currentColor; }
  .btn { font-family:var(--font); font-weight:600; font-size:13px; padding:9px 18px; border-radius:8px; border:none; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:7px; }
  .btn:disabled { opacity:0.4; cursor:not-allowed; }
  .btn-primary { background:var(--accent); color:white; box-shadow:0 4px 16px rgba(249,115,22,0.25); }
  .btn-primary:hover:not(:disabled) { background:var(--accent2); transform:translateY(-1px); }
  .btn-ghost { background:rgba(148,163,184,0.08); color:var(--text2); border:1px solid var(--border); }
  .btn-ghost:hover { background:rgba(148,163,184,0.14); color:var(--text); }
  .btn-danger { background:rgba(248,113,113,0.1); color:var(--red); border:1px solid rgba(248,113,113,0.2); }
  .btn-danger:hover { background:rgba(248,113,113,0.2); }
  .btn-sm { padding:6px 12px; font-size:12px; }
  .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .form-group { display:flex; flex-direction:column; gap:6px; }
  label { font-size:11px; font-weight:600; color:var(--text2); letter-spacing:0.5px; text-transform:uppercase; font-family:var(--mono); }
  input, select { background:var(--surface2); border:1px solid var(--border2); border-radius:8px; padding:10px 14px; font-family:var(--mono); font-size:13px; color:var(--text); outline:none; transition:border-color 0.2s; width:100%; }
  input:focus, select:focus { border-color:var(--accent); }
  input::placeholder { color:var(--muted); }
  select option { background:var(--surface2); }
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:1000; display:none; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border2); border-radius:16px; padding:28px; width:100%; max-width:480px; box-shadow:0 24px 64px rgba(0,0,0,0.6); animation:modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes modalIn { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }
  .modal-title { font-size:18px; font-weight:800; margin-bottom:20px; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:24px; }
  .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .filters input, .filters select { width:auto; min-width:140px; padding:8px 12px; font-size:12px; }
  .search-wrap { position:relative; }
  .search-wrap input { padding-left:34px; }
  .search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:14px; pointer-events:none; }
  .today-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
  .today-col { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:14px; }
  .today-col-title { font-size:11px; color:var(--text2); font-family:var(--mono); letter-spacing:1px; text-transform:uppercase; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
  .today-name { font-size:12px; color:var(--text); padding:6px 0; border-bottom:1px solid var(--border); font-family:var(--mono); }
  .today-name:last-child { border-bottom:none; }
  .settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .settings-card { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:20px; }
  .settings-card-title { font-size:13px; font-weight:700; margin-bottom:16px; }
  .empty-state { text-align:center; padding:48px; color:var(--muted); font-family:var(--mono); font-size:13px; }
  .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(249,115,22,0.2); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-thumb { background:var(--muted); border-radius:3px; }
  @media(max-width:768px){
    .sidebar{transform:translateX(-100%)} .main{margin-left:0;padding:16px}
    .stats-grid{grid-template-columns:1fr 1fr} .form-grid{grid-template-columns:1fr} .settings-grid{grid-template-columns:1fr}
  }

  /* ‚îÄ‚îÄ HAMBURGER & MOBILE SIDEBAR ‚îÄ‚îÄ */
  .hamburger { display:none; flex-direction:column; gap:5px; cursor:pointer; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); flex-shrink:0; position:fixed; top:14px; left:14px; z-index:200; }
  .hamburger span { display:block; width:20px; height:2px; background:var(--text2); border-radius:2px; transition:all 0.3s; }
  .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:400; opacity:0; pointer-events:none; transition:opacity 0.3s; }
  .sidebar-overlay.open { opacity:1; pointer-events:all; }
  .table-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  @media(max-width:768px){
    .hamburger { display:flex; }
    .sidebar { transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1); z-index:500 !important; }
    .sidebar.open { transform:translateX(0) !important; box-shadow:8px 0 40px rgba(0,0,0,0.5); }
    .main { margin-left:0 !important; padding:14px !important; padding-top:60px !important; }
    .stats-grid { grid-template-columns:1fr 1fr !important; }
    .today-grid { grid-template-columns:1fr !important; }
    .settings-grid { grid-template-columns:1fr !important; }
    .form-grid { grid-template-columns:1fr !important; }
    .plan-grid { grid-template-columns:repeat(2,1fr) !important; }
    .company-grid { grid-template-columns:1fr !important; }
    table { min-width:500px; }
    .page-header { flex-direction:column; align-items:flex-start !important; }
    .modal { margin:0 8px; padding:20px; max-width:calc(100vw - 16px); }
    .filters { gap:6px; }
    .filters input, .filters select { min-width:100px; }
    .notif { min-width:200px; max-width:calc(100vw - 40px); }
    #notif { top:14px; right:14px; }
  }
  @media(max-width:400px){
    .stats-grid { grid-template-columns:1fr 1fr !important; }
    .stat-value { font-size:24px !important; }
  }
</style>
</head>
<body>
<div id="notif"></div>
<button class="hamburger" id="hamburgerBtn" aria-label="Open menu">
  <span></span><span></span><span></span>
</button>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="sidebar-brand-icon">‚ö°</div>
      <div><div class="sidebar-brand-name">WorkPulse</div><div class="sidebar-brand-role">COMPANY ADMIN</div></div>
    </div>
    <div class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">üìä</span> Dashboard</div>
      <div class="nav-item" data-page="today"><span class="nav-icon">üìÖ</span> Today's Status</div>
    </div>
    <div class="nav-section" style="margin-top:12px">
      <div class="nav-label">Employees</div>
      <div class="nav-item" data-page="employees"><span class="nav-icon">üë•</span> Employees</div>
      <div class="nav-item" data-page="attendance"><span class="nav-icon">üïê</span> Attendance</div>
      <div class="nav-item" data-page="reports"><span class="nav-icon">üìà</span> Reports</div>
    </div>
    <div class="nav-section" style="margin-top:12px">
      <div class="nav-label">Company</div>
      <div class="nav-item" data-page="settings"><span class="nav-icon">‚öôÔ∏è</span> Settings</div>
    </div>
    <div class="sidebar-bottom">
      <div class="sidebar-user">
        <div class="sidebar-email" id="adminEmail">‚Äî</div>
        <button class="btn-logout" id="logoutBtn">Sign Out</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div class="page-title">Dashboard</div>
        <div class="page-sub" id="companyName">Loading‚Ä¶</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card orange"><div class="stat-icon">üë•</div><div class="stat-value" id="stat-total">‚Äî</div><div class="stat-label">Total Employees</div></div>
        <div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-present">‚Äî</div><div class="stat-label">Present Today</div></div>
        <div class="stat-card red"><div class="stat-icon">‚ùå</div><div class="stat-value" id="stat-absent">‚Äî</div><div class="stat-label">Absent Today</div></div>
        <div class="stat-card yellow"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="stat-late">‚Äî</div><div class="stat-label">Late Today</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">üìã Today's Attendance</div>
          <div id="todayDate" style="font-family:var(--mono);font-size:12px;color:var(--text2)"></div>
        </div>
        <div class='table-scroll'><table><thead><tr><th>Employee</th><th>In Time</th><th>Out Time</th><th>Duration</th><th>Status</th></tr></thead>
        <tbody id="dashAttendanceTable"><tr><td colspan="5" class="empty-state"><div class="spinner"></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div class="page" id="page-today">
      <div class="page-header"><div class="page-title">Today's Status</div><div class="page-sub">Real-time employee presence overview</div></div>
      <div class="today-grid">
        <div class="today-col"><div class="today-col-title"><span style="color:var(--green)">‚óè</span> Checked In</div><div id="today-in-list"><div class="spinner"></div></div></div>
        <div class="today-col"><div class="today-col-title"><span style="color:var(--red)">‚óè</span> Not Yet In</div><div id="today-out-list"><div class="spinner"></div></div></div>
        <div class="today-col"><div class="today-col-title"><span style="color:var(--yellow)">‚óè</span> Checked Out</div><div id="today-done-list"><div class="spinner"></div></div></div>
      </div>
    </div>

    <div class="page" id="page-employees">
      <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div><div class="page-title">Employees</div><div class="page-sub">Manage your team members</div></div>
        <button class="btn btn-primary" id="addEmpBtn">Ôºã Add Employee</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="filters">
            <div class="search-wrap"><span class="search-icon">üîç</span><input type="text" id="empSearch" placeholder="Search name‚Ä¶"></div>
            <select id="empStatusFilter"><option value="">All Status</option><option value="active">Active</option><option value="inactive">Inactive</option></select>
          </div>
        </div>
        <div class='table-scroll'><table><thead><tr><th>Name</th><th>Role</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="empTable"><tr><td colspan="5" class="empty-state"><div class="spinner"></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div class="page" id="page-attendance">
      <div class="page-header"><div class="page-title">Attendance Records</div><div class="page-sub">View and filter all attendance history</div></div>
      <div class="card">
        <div class="card-header">
          <div class="filters">
            <input type="date" id="attDateFrom"><input type="date" id="attDateTo">
            <select id="attEmpFilter"><option value="">All Employees</option></select>
            <button class="btn btn-ghost btn-sm" id="attFilterBtn">Filter</button>
            <button class="btn btn-ghost btn-sm" id="attExportBtn">‚¨á Export CSV</button>
          </div>
        </div>
        <div class='table-scroll'><table><thead><tr><th>Employee</th><th>Date</th><th>In Time</th><th>Out Time</th><th>Duration</th><th>Status</th></tr></thead>
        <tbody id="attTable"><tr><td colspan="6" class="empty-state"><div class="spinner"></div></td></tr></tbody></table></div>
      </div>
    </div>

    <div class="page" id="page-reports">
      <div class="page-header"><div class="page-title">Reports</div><div class="page-sub">Monthly summary per employee</div></div>
      <div class="card">
        <div class="card-header">
          <div class="filters">
            <select id="reportMonth"></select>
            <select id="reportEmp"><option value="">All Employees</option></select>
            <button class="btn btn-ghost btn-sm" id="reportGenBtn">Generate</button>
            <button class="btn btn-ghost btn-sm" id="reportExportBtn">‚¨á Export CSV</button>
          </div>
        </div>
        <div class='table-scroll'><table><thead><tr><th>Employee</th><th>Present Days</th><th>Absent Days</th><th>Late Days</th><th>Total Hours</th><th>Avg Hours/Day</th></tr></thead>
        <tbody id="reportTable"><tr><td colspan="6" class="empty-state">Select a month and click Generate</td></tr></tbody></table></div>
      </div>
    </div>

    <div class="page" id="page-settings">
      <div class="page-header"><div class="page-title">Company Settings</div><div class="page-sub">Manage your company configuration</div></div>
      <div class="settings-grid">
        <div class="settings-card">
          <div class="settings-card-title">üè¢ Company Info</div>
          <div class="form-group" style="margin-bottom:14px"><label>Company Name</label><input type="text" id="settingCompanyName"></div>
          <div class="form-group" style="margin-bottom:14px"><label>Seat Limit</label><input type="number" id="settingSeatLimit"></div>
          <button class="btn btn-primary" id="saveCompanyBtn">Save Changes</button>
        </div>
        <div class="settings-card">
          <div class="settings-card-title">‚è∞ Office Hours</div>
          <div class="form-group" style="margin-bottom:14px"><label>Office Start Time (BD)</label><input type="time" id="settingOfficeStart" value="09:00"></div>
          <div class="form-group" style="margin-bottom:14px"><label>Grace Period (minutes)</label><input type="number" id="settingGrace" value="15"></div>
          <button class="btn btn-primary" id="saveOfficeBtn">Save Hours</button>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay" id="addEmpModal">
  <div class="modal">
    <div class="modal-title">üë§ Add New Employee</div>
    <div class="form-grid">
      <div class="form-group"><label>Full Name</label><input type="text" id="newEmpName" placeholder="John Doe"></div>
      <div class="form-group"><label>Email</label><input type="email" id="newEmpEmail" placeholder="john@company.com"></div>
      <div class="form-group"><label>Password</label><input type="text" id="newEmpPass" placeholder="Min 6 characters"></div>
      <div class="form-group"><label>Role</label>
        <select id="newEmpRole"><option value="employee">Employee</option><option value="company_admin">Company Admin</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="cancelEmpBtn">Cancel</button>
      <button class="btn btn-primary" id="saveEmpBtn">Create Employee</button>
    </div>
  </div>
</div>

<script type="module">
import { checkSession, logoutUser, supabase } from "./js/auth.js";

const EDGE_URL = "https://nciahmkjmpowidzauzam.supabase.co/functions/v1/create-employee";

function notify(msg, type="info") {
  const icons = {success:"‚úì",error:"‚úï",info:"‚Ñπ"};
  const c = document.getElementById("notif");
  const el = document.createElement("div");
  el.className = "notif "+type;
  el.innerHTML = "<span>"+icons[type]+"</span><span>"+msg+"</span>";
  c.appendChild(el);
  requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add("show")));
  setTimeout(()=>{el.classList.add("hide");el.addEventListener("transitionend",()=>el.remove(),{once:true});},3500);
}

function bdTime(t) {
  if (!t) return "‚Äî";
  const s = t.includes("Z") ? t : t.replace(" ","T")+"Z";
  const bd = new Date(new Date(s).getTime()+6*60*60*1000);
  let h=bd.getUTCHours(), m=String(bd.getUTCMinutes()).padStart(2,"0"), sec=String(bd.getUTCSeconds()).padStart(2,"0");
  const ap=h>=12?"PM":"AM"; h=h%12||12;
  return String(h).padStart(2,"0")+":"+m+":"+sec+" "+ap;
}
function bdDate(d) {
  if (!d) return "‚Äî";
  const [y,mo,day]=d.split("-").map(Number);
  return new Date(y,mo-1,day).toLocaleDateString("en-US",{weekday:"short",day:"2-digit",month:"short",year:"numeric"});
}
function dur(a,b) {
  if (!a||!b) return "‚Äî";
  const sa=a.includes("Z")?a:a.replace(" ","T")+"Z";
  const sb=b.includes("Z")?b:b.replace(" ","T")+"Z";
  const m=Math.floor((new Date(sb)-new Date(sa))/60000);
  return m<0?"‚Äî":Math.floor(m/60)+"h "+m%60+"m";
}
function todayBD() { return new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Dhaka"}); }
function isLate(t,start,grace) {
  if (!t) return false;
  const s=t.includes("Z")?t:t.replace(" ","T")+"Z";
  const bd=new Date(new Date(s).getTime()+6*60*60*1000);
  const [oh,om]=start.split(":").map(Number);
  return (bd.getUTCHours()*60+bd.getUTCMinutes())>(oh*60+om+(grace||15));
}

document.querySelectorAll(".nav-item").forEach(item=>{
  item.addEventListener("click",()=>{
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    item.classList.add("active");
    document.getElementById("page-"+item.dataset.page).classList.add("active");
    const p=item.dataset.page;
    if(p==="today")      loadTodayStatus();
    if(p==="employees")  loadEmployees();
    if(p==="attendance") loadAttendancePage();
    if(p==="reports")    initReports();
    if(p==="settings")   loadSettings();
  });
});

const user = await checkSession();
if (!user) throw new Error("no session");

const {data:profile, error:pe} = await supabase.from("profiles").select("role,company_id").eq("id",user.id).single();
if (pe || !profile) { alert("Profile load failed: "+(pe?.message||"null")); throw new Error("no profile"); }
if (profile.role==="employee") { window.location.href="dashboard.html"; }

const companyId = profile.company_id;
let officeStart = "09:00";
let graceMins   = 15;
let companyData = null;

document.getElementById("adminEmail").textContent = user.email;
document.getElementById("todayDate").textContent = new Date().toLocaleDateString("en-US",{weekday:"long",day:"numeric",month:"long",year:"numeric",timeZone:"Asia/Dhaka"});

if (companyId) {
  const {data:co} = await supabase.from("companies").select("*").eq("id",companyId).single();
  if (co) {
    companyData = co;
    officeStart = co.office_start_time || "09:00";
    document.getElementById("companyName").textContent = co.name+" ¬∑ "+co.seat_limit+" seat limit";
  }
} else {
  document.getElementById("companyName").textContent = "‚ö†Ô∏è No company assigned";
}

document.getElementById("logoutBtn").addEventListener("click",()=>{notify("Signing out‚Ä¶","info");setTimeout(logoutUser,700);});

let allEmployees = [];

async function fetchEmployees() {
  if (!companyId) return [];
  const {data,error} = await supabase.from("profiles").select("*").eq("company_id",companyId).neq("role","super_admin");
  if (error) { notify("Error: "+error.message,"error"); return []; }
  return data||[];
}

async function loadDashboard() {
  const emps = await fetchEmployees();
  allEmployees = emps;
  if (!emps.length) {
    ["stat-total","stat-present","stat-absent","stat-late"].forEach(id=>document.getElementById(id).textContent="0");
    document.getElementById("dashAttendanceTable").innerHTML="<tr><td colspan='5' class='empty-state'>No employees found</td></tr>";
    return;
  }
  const {data:att} = await supabase.from("attendance").select("*").in("user_id",emps.map(e=>e.id)).eq("date",todayBD());
  const recs=att||[], active=emps.filter(e=>e.is_active!==false);
  document.getElementById("stat-total").textContent=active.length;
  document.getElementById("stat-present").textContent=recs.length;
  document.getElementById("stat-absent").textContent=Math.max(0,active.length-recs.length);
  document.getElementById("stat-late").textContent=recs.filter(a=>isLate(a.in_time,officeStart,graceMins)).length;
  const tbody=document.getElementById("dashAttendanceTable");
  if (!recs.length){tbody.innerHTML="<tr><td colspan='5' class='empty-state'>No attendance records for today</td></tr>";return;}
  tbody.innerHTML=recs.map(a=>{
    const emp=emps.find(e=>e.id===a.user_id);
    const name=emp?.full_name||a.user_id.substring(0,8)+"‚Ä¶";
    const late=isLate(a.in_time,officeStart,graceMins);
    return "<tr><td>"+name+"</td><td>"+bdTime(a.in_time)+"</td><td>"+bdTime(a.out_time)+"</td><td>"+dur(a.in_time,a.out_time)+"</td><td>"+(late?"<span class='badge badge-yellow'><span class='badge-dot'></span>Late</span>":"<span class='badge badge-green'><span class='badge-dot'></span>Present</span>")+"</td></tr>";
  }).join("");
}
loadDashboard();

async function loadTodayStatus() {
  const emps=await fetchEmployees();
  const {data:att}=await supabase.from("attendance").select("*").in("user_id",emps.map(e=>e.id)).eq("date",todayBD());
  const recs=att||[];
  const nameOf=id=>emps.find(e=>e.id===id)?.full_name||id.substring(0,8)+"‚Ä¶";
  const inIds=recs.filter(a=>a.in_time&&!a.out_time).map(a=>a.user_id);
  const outIds=recs.filter(a=>a.out_time).map(a=>a.user_id);
  const noIds=emps.filter(e=>e.is_active!==false&&!recs.find(a=>a.user_id===e.id)).map(e=>e.id);
  const render=(ids,elId)=>{document.getElementById(elId).innerHTML=ids.length?ids.map(id=>"<div class='today-name'>"+nameOf(id)+"</div>").join(""):"<div class='today-name' style='color:var(--muted)'>None</div>";};
  render(inIds,"today-in-list"); render(noIds,"today-out-list"); render(outIds,"today-done-list");
}

async function loadEmployees() {
  const emps=await fetchEmployees(); allEmployees=emps; renderEmpTable(emps);
  const attSel=document.getElementById("attEmpFilter"), repSel=document.getElementById("reportEmp");
  attSel.innerHTML="<option value=''>All Employees</option>";
  repSel.innerHTML="<option value=''>All Employees</option>";
  emps.forEach(e=>{const n=e.full_name||e.id.substring(0,8); attSel.innerHTML+="<option value='"+e.id+"'>"+n+"</option>"; repSel.innerHTML+="<option value='"+e.id+"'>"+n+"</option>";});
}

function renderEmpTable(emps) {
  const tbody=document.getElementById("empTable");
  if(!emps.length){tbody.innerHTML="<tr><td colspan='5' class='empty-state'>No employees found</td></tr>";return;}
  tbody.innerHTML=emps.map(e=>{
    const active=e.is_active!==false;
    const joined=e.created_at?new Date(e.created_at).toLocaleDateString("en-US",{day:"2-digit",month:"short",year:"numeric"}):"‚Äî";
    return "<tr><td>"+(e.full_name||"‚Äî")+"</td><td>"+(e.role==="company_admin"?"<span class='badge badge-orange'>Admin</span>":"<span class='badge badge-muted'>Employee</span>")+"</td><td>"+(active?"<span class='badge badge-green'><span class='badge-dot'></span>Active</span>":"<span class='badge badge-red'><span class='badge-dot'></span>Inactive</span>")+"</td><td>"+joined+"</td><td style='display:flex;gap:6px'><button class='btn btn-ghost btn-sm' onclick=\"editEmp('"+e.id+"')\">Edit</button><button class='btn "+(active?"btn-danger":"btn-ghost")+" btn-sm' onclick=\"toggleEmp('"+e.id+"',"+active+")\">"+( active?"Deactivate":"Activate")+"</button></td></tr>";
  }).join("");
}

document.getElementById("empSearch").addEventListener("input",function(){renderEmpTable(allEmployees.filter(e=>(e.full_name||"").toLowerCase().includes(this.value.toLowerCase())));});
document.getElementById("empStatusFilter").addEventListener("change",function(){renderEmpTable(this.value===""?allEmployees:this.value==="active"?allEmployees.filter(e=>e.is_active!==false):allEmployees.filter(e=>e.is_active===false));});

window.toggleEmp=async(id,active)=>{
  const{error}=await supabase.from("profiles").update({is_active:!active}).eq("id",id);
  if(error){notify("Error: "+error.message,"error");return;}
  notify(active?"Employee deactivated":"Employee activated","success"); loadEmployees();
};
window.editEmp=async(id)=>{
  const emp=allEmployees.find(e=>e.id===id);
  const n=prompt("Full name:",emp?.full_name||""); if(n===null)return;
  const{error}=await supabase.from("profiles").update({full_name:n}).eq("id",id);
  if(error){notify("Error: "+error.message,"error");return;}
  notify("Employee updated","success"); loadEmployees();
};

document.getElementById("addEmpBtn").addEventListener("click",()=>document.getElementById("addEmpModal").classList.add("open"));
document.getElementById("cancelEmpBtn").addEventListener("click",()=>document.getElementById("addEmpModal").classList.remove("open"));

document.getElementById("saveEmpBtn").addEventListener("click",async()=>{
  const name  = document.getElementById("newEmpName").value.trim();
  const email = document.getElementById("newEmpEmail").value.trim();
  const pass  = document.getElementById("newEmpPass").value.trim();
  const role  = document.getElementById("newEmpRole").value;

  if (!email) { notify("Email is required","error"); return; }
  if (!pass||pass.length<6) { notify("Password must be at least 6 characters","error"); return; }
  if (!companyId) { notify("No company assigned to your account","error"); return; }

  const btn=document.getElementById("saveEmpBtn");
  btn.disabled=true; btn.textContent="Creating‚Ä¶";

  try {
    const {data:sd} = await supabase.auth.getSession();
    const token = sd?.session?.access_token;
    if (!token) { notify("Session expired, please login again","error"); btn.disabled=false; btn.textContent="Create Employee"; return; }

    const res = await fetch(EDGE_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
      body: JSON.stringify({email, password:pass, full_name:name||null, role, company_id:companyId})
    });

    let result;
    try { result = await res.json(); } catch(e) { notify("Invalid response from server","error"); btn.disabled=false; btn.textContent="Create Employee"; return; }

    if (result.error) {
      notify("Error: "+result.error,"error");
    } else {
      notify("Employee "+email+" created!","success");
      document.getElementById("addEmpModal").classList.remove("open");
      document.getElementById("newEmpName").value="";
      document.getElementById("newEmpEmail").value="";
      document.getElementById("newEmpPass").value="";
      loadEmployees();
    }
  } catch(err) {
    notify("Network error: "+err.message,"error");
  }

  btn.disabled=false; btn.textContent="Create Employee";
});

async function loadAttendancePage() {
  if(!allEmployees.length) await loadEmployees();
  const to=todayBD(), from=new Date(Date.now()-6*24*60*60*1000).toLocaleDateString("en-CA",{timeZone:"Asia/Dhaka"});
  document.getElementById("attDateFrom").value=from; document.getElementById("attDateTo").value=to;
  fetchAttendance(from,to,"");
}

async function fetchAttendance(from,to,empId) {
  const tbody=document.getElementById("attTable");
  tbody.innerHTML="<tr><td colspan='6' class='empty-state'><div class='spinner'></div></td></tr>";
  if(!allEmployees.length){tbody.innerHTML="<tr><td colspan='6' class='empty-state'>No employees</td></tr>";return;}
  let q=supabase.from("attendance").select("*").in("user_id",allEmployees.map(e=>e.id)).gte("date",from).lte("date",to).order("date",{ascending:false});
  if(empId) q=q.eq("user_id",empId);
  const{data,error}=await q;
  if(error){notify("Error: "+error.message,"error");return;}
  if(!data?.length){tbody.innerHTML="<tr><td colspan='6' class='empty-state'>No records found</td></tr>";return;}
  tbody.innerHTML=data.map(a=>{
    const emp=allEmployees.find(e=>e.id===a.user_id);
    const name=emp?.full_name||a.user_id.substring(0,8)+"‚Ä¶";
    const late=isLate(a.in_time,officeStart,graceMins);
    return "<tr><td>"+name+"</td><td>"+bdDate(a.date)+"</td><td>"+bdTime(a.in_time)+"</td><td>"+bdTime(a.out_time)+"</td><td>"+dur(a.in_time,a.out_time)+"</td><td>"+(late?"<span class='badge badge-yellow'><span class='badge-dot'></span>Late</span>":"<span class='badge badge-green'><span class='badge-dot'></span>Present</span>")+"</td></tr>";
  }).join("");
  window._attData=data;
}

document.getElementById("attFilterBtn").addEventListener("click",()=>fetchAttendance(document.getElementById("attDateFrom").value,document.getElementById("attDateTo").value,document.getElementById("attEmpFilter").value));
document.getElementById("attExportBtn").addEventListener("click",()=>{
  if(!window._attData?.length){notify("No data to export","info");return;}
  exportCSV(window._attData.map(a=>{const emp=allEmployees.find(e=>e.id===a.user_id);return{Employee:emp?.full_name||a.user_id,Date:a.date,"In Time":bdTime(a.in_time),"Out Time":bdTime(a.out_time),Duration:dur(a.in_time,a.out_time),Status:isLate(a.in_time,officeStart,graceMins)?"Late":"Present"};}), "attendance_export");
});

function initReports() {
  if(!allEmployees.length) loadEmployees();
  const sel=document.getElementById("reportMonth"); sel.innerHTML="";
  const now=new Date();
  for(let i=0;i<12;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);sel.innerHTML+="<option value='"+d.toLocaleDateString("en-CA").substring(0,7)+"'>"+d.toLocaleDateString("en-US",{month:"long",year:"numeric"})+"</option>";}
}

document.getElementById("reportGenBtn").addEventListener("click",async()=>{
  const month=document.getElementById("reportMonth").value, empId=document.getElementById("reportEmp").value;
  if(!month){notify("Select a month","info");return;}
  const [y,m]=month.split("-").map(Number);
  const from=month+"-01", to=new Date(y,m,0).toISOString().split("T")[0];
  let q=supabase.from("attendance").select("*").in("user_id",allEmployees.map(e=>e.id)).gte("date",from).lte("date",to);
  if(empId) q=q.eq("user_id",empId);
  const{data,error}=await q;
  if(error){notify("Error: "+error.message,"error");return;}
  const totalDays=new Date(y,m,0).getDate();
  const emps=empId?allEmployees.filter(e=>e.id===empId):allEmployees;
  const rows=emps.map(e=>{
    const recs=(data||[]).filter(a=>a.user_id===e.id);
    const pDays=recs.length, lDays=recs.filter(a=>isLate(a.in_time,officeStart,graceMins)).length;
    const totalM=recs.reduce((s,a)=>{if(!a.in_time||!a.out_time)return s;const ai=a.in_time.includes("Z")?a.in_time:a.in_time.replace(" ","T")+"Z";const ao=a.out_time.includes("Z")?a.out_time:a.out_time.replace(" ","T")+"Z";return s+Math.max(0,Math.floor((new Date(ao)-new Date(ai))/60000));},0);
    const avgM=pDays>0?Math.floor(totalM/pDays):0;
    return{emp:e,presentDays:pDays,absentDays:Math.max(0,totalDays-pDays),lateDays:lDays,totalHrs:Math.floor(totalM/60)+"h "+totalM%60+"m",avgHrs:Math.floor(avgM/60)+"h "+avgM%60+"m"};
  });
  const tbody=document.getElementById("reportTable");
  tbody.innerHTML=rows.length?rows.map(r=>"<tr><td>"+(r.emp.full_name||r.emp.id.substring(0,8)+"‚Ä¶")+"</td><td><span class='badge badge-green'>"+r.presentDays+"</span></td><td><span class='badge badge-red'>"+r.absentDays+"</span></td><td><span class='badge badge-yellow'>"+r.lateDays+"</span></td><td>"+r.totalHrs+"</td><td>"+r.avgHrs+"</td></tr>").join(""):"<tr><td colspan='6' class='empty-state'>No data</td></tr>";
  window._reportData=rows;
});

document.getElementById("reportExportBtn").addEventListener("click",()=>{
  if(!window._reportData?.length){notify("Generate report first","info");return;}
  exportCSV(window._reportData.map(r=>({Employee:r.emp.full_name||r.emp.id,"Present Days":r.presentDays,"Absent Days":r.absentDays,"Late Days":r.lateDays,"Total Hours":r.totalHrs,"Avg Hours/Day":r.avgHrs})),"monthly_report");
});

function loadSettings() {
  if(!companyData)return;
  document.getElementById("settingCompanyName").value=companyData.name||"";
  document.getElementById("settingSeatLimit").value=companyData.seat_limit||"";
  document.getElementById("settingOfficeStart").value=companyData.office_start_time||"09:00";
}
document.getElementById("saveCompanyBtn").addEventListener("click",async()=>{
  const name=document.getElementById("settingCompanyName").value.trim(), seats=parseInt(document.getElementById("settingSeatLimit").value);
  if(!name){notify("Company name required","error");return;}
  const{error}=await supabase.from("companies").update({name,seat_limit:seats}).eq("id",companyId);
  if(error){notify("Error: "+error.message,"error");return;}
  notify("Company info saved!","success"); document.getElementById("companyName").textContent=name+" ¬∑ "+seats+" seat limit";
  if(companyData){companyData.name=name;companyData.seat_limit=seats;}
});
document.getElementById("saveOfficeBtn").addEventListener("click",async()=>{
  const start=document.getElementById("settingOfficeStart").value, grace=parseInt(document.getElementById("settingGrace").value)||15;
  const{error}=await supabase.from("companies").update({office_start_time:start}).eq("id",companyId);
  if(error){notify("Error: "+error.message,"error");return;}
  officeStart=start; graceMins=grace; notify("Office hours saved!","success");
});

function exportCSV(rows,filename) {
  if(!rows.length)return;
  const h=Object.keys(rows[0]);
  const csv=[h.join(","),...rows.map(r=>h.map(k=>'"'+r[k]+'"').join(","))].join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=filename+"_"+todayBD()+".csv"; a.click();
  notify("CSV exported!","success");
}

// ‚îÄ‚îÄ MOBILE SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const hamburgerBtn = document.getElementById("hamburgerBtn");
const sidebarOverlay = document.getElementById("sidebarOverlay");
const sidebar = document.querySelector(".sidebar");
hamburgerBtn.addEventListener("click", () => {
  sidebar.classList.toggle("open");
  sidebarOverlay.classList.toggle("open");
});
sidebarOverlay.addEventListener("click", () => {
  sidebar.classList.remove("open");
  sidebarOverlay.classList.remove("open");
});
// Close sidebar on nav item click on mobile
document.querySelectorAll(".nav-item").forEach(item => {
  item.addEventListener("click", () => {
    if (window.innerWidth <= 768) {
      sidebar.classList.remove("open");
      sidebarOverlay.classList.remove("open");
    }
  });
});

// PWA service worker
if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./sw.js").catch(()=>{}); }

</script>
</body>
</html>
